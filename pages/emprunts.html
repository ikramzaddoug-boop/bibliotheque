<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gestion des Emprunts</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<script>
  if (localStorage.getItem("isLoggedIn") !== "true") location.href = "../login.html";
</script>

<div class="container-fluid">
  <div class="row min-vh-100">
     <aside class="col-12 col-md-3 col-lg-2 bg-dark text-white p-3" role="navigation">
      <div class="text-center mb-4"><h4>üìö Biblioth√®que</h4></div>
      <nav><ul class="nav flex-column gap-1">
        <li class="nav-item"><a href="../dashboard.html" class="nav-link text-white active"><i class="bi bi-speedometer2 me-1"></i> Dashboard</a></li>
        <li class="nav-item"><a href="livres.html" class="nav-link text-white"><i class="bi bi-book me-1"></i> Livres</a></li>
        <li class="nav-item"><a href="auteurs.html" class="nav-link text-white"><i class="bi bi-person-lines-fill me-1"></i> Auteurs</a></li>
        <li class="nav-item"><a href="categories.html" class="nav-link text-white"><i class="bi bi-tags me-1"></i> Cat√©gories</a></li>
        <li class="nav-item"><a href="adherents.html" class="nav-link text-white"><i class="bi bi-people me-1"></i> Adh√©rents</a></li>
        <li class="nav-item"><a href="emprunts.html" class="nav-link text-white"><i class="bi bi-arrow-left-right me-1"></i> Emprunts</a></li>
      </ul></nav>
      <footer class="mt-4"><button id="logoutBtn" class="btn btn-danger w-100"><i class="bi bi-box-arrow-right me-1"></i> D√©connexion</button></footer>
    </aside>

    <main class="col-12 col-md-9 col-lg-10 p-4">
      <div class="topbar mb-3 d-flex gap-2 align-items-center">
        <form class="search flex-grow-1" onsubmit="event.preventDefault();">
          <input id="globalSearch" class="form-control" type="search" placeholder="Rechercher livre ou adh√©rent..." aria-label="Rechercher">
        </form>
        <div class="d-flex gap-2 align-items-center">
          <button id="resetDataBtn" class="btn btn-outline-secondary btn-sm" title="R√©initialiser les donn√©es d'exemple">Reset sample data</button>
          <div class="user-badge"><div class="avatar">A</div></div>
        </div>
      </div>

      <header class="mb-4">
        <h2>Gestion des Emprunts</h2>
        <p class="text-muted">Enregistrer et suivre les emprunts</p>
      </header>

      <section class="mb-4">
        <div class="card p-3">
          <h5>Nouvel emprunt</h5>
          <form id="formEmprunt" class="mt-3">
            <div class="mb-3">
              <label for="livreSelect" class="form-label">Livre</label>
              <select id="livreSelect" class="form-select" required></select>
              <small id="livreAvailabilityNote" class="form-text text-muted mt-1"></small>
            </div>
            <div class="mb-3">
              <label for="adherentSelect" class="form-label">Adh√©rent</label>
              <select id="adherentSelect" class="form-select" required></select>
            </div>
            <div class="mb-3">
              <label for="dateEmprunt" class="form-label">Date d'emprunt</label>
              <input id="dateEmprunt" class="form-control" type="date" required>
            </div>
            <button type="submit" class="btn btn-success">Enregistrer</button>
          </form>
        </div>
      </section>

      <section>
        <div class="card p-3">
          <h5>Liste des emprunts</h5>
          <div id="empruntsContainer" class="row g-4 mt-3"></div>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="../js/storage.js"></script>

<script>
(async function initApp() {
  const dataFiles = [
    { key: 'livres', file: '../data/livres.json', normalize: l => ({ ...l, disponible: l.disponible !== false }) },
    { key: 'adherents', file: '../data/adherents.json' },
    { key: 'auteurs', file: '../data/auteurs.json' },
    { key: 'categories', file: '../data/categories.json' },
    { key: 'emprunts', file: '../data/emprunts.json' }
  ];

  // Fetch all data and store in localStorage
  for (let item of dataFiles) {
    const res = await fetch(item.file);
    const json = await res.json();
    const out = Array.isArray(json) ? (item.normalize ? json.map(item.normalize) : json) : [];
    localStorage.setItem(item.key, JSON.stringify(out));
  }

  // Load emprunts.js after data is ready
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = '../js/emprunts.js';
    s.onload = resolve;
    s.onerror = () => reject('Failed to load emprunts.js');
    document.body.appendChild(s);
  });

  if (typeof initEmprunts === 'function') initEmprunts();

  // Reset button
  document.getElementById('resetDataBtn').addEventListener('click', async () => {
    if (!confirm('R√©initialiser les donn√©es d\'exemple ?')) return;
    localStorage.removeItem('livres');
    localStorage.removeItem('adherents');
    localStorage.removeItem('emprunts');
    location.reload();
  });

  // Search
  document.getElementById('globalSearch')?.addEventListener('input', e => {
    const q = (e.target.value || '').trim().toLowerCase();
    document.querySelectorAll('#empruntsContainer .card').forEach(card => {
      const title = card.querySelector('h5')?.textContent?.toLowerCase() || '';
      const adh = Array.from(card.querySelectorAll('p')).map(p => p.textContent.toLowerCase()).join(' ');
      card.parentElement.style.display = (q === '' || title.includes(q) || adh.includes(q)) ? '' : 'none';
    });
  });

  // Logout
  document.addEventListener('click', ev => {
    if (ev.target.closest('#logoutBtn')) {
      localStorage.removeItem('isLoggedIn');
      location.href = '../login.html';
    }
  });
})();
</script>
</body>

</html>
